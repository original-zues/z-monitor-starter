<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Z Monitor | Enterprise Command Center</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #3b82f6;
            --bg-dark: #0f172a;
            --card-bg: #1e293b;
            --text-main: #f8fafc;
            --text-dim: #94a3b8;
            --border: rgba(255, 255, 255, 0.05);
        }
        body { 
            background: var(--bg-dark); 
            color: var(--text-main); 
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
        }
        .mono { font-family: 'JetBrains Mono', monospace; }
        .card { 
            background: var(--card-bg); 
            border: 1px solid var(--border);
            border-radius: 0.75rem;
            transition: all 0.2s ease;
        }
        .sidebar-item {
            display: flex;
            items-center: center;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            color: var(--text-dim);
            font-weight: 500;
            transition: all 0.2s ease;
        }
        .sidebar-item.active {
            background: rgba(59, 130, 246, 0.1);
            color: #fff;
            box-shadow: inset 2px 0 0 var(--primary);
        }
        .sidebar-item:hover:not(.active) {
            background: rgba(255, 255, 255, 0.03);
            color: var(--text-main);
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(4px); } to { opacity: 1; transform: translateY(0); } }
        
        .status-pill {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .status-up { background: rgba(16, 185, 129, 0.1); color: #10b981; }
        .status-down { background: rgba(239, 68, 68, 0.1); color: #ef4444; }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.1); border-radius: 3px; }
        
        .grid-dashboard {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1.5rem;
        }
    </style>
</head>
<body class="h-screen flex overflow-hidden">
    <!-- Navigation Sidebar -->
    <aside class="w-64 bg-[#0a0f1d] border-r border-white/5 flex flex-col">
        <div class="p-6 flex items-center space-x-3">
            <div class="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center shadow-lg shadow-blue-500/20">
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
            </div>
            <div>
                <h1 th:text="${appName}" class="text-sm font-bold tracking-tight uppercase truncate max-w-[120px]">Z-MONITOR</h1>
                <p th:text="${environment}" class="text-[10px] text-slate-500 font-bold uppercase tracking-widest italic">SRE Suite v6.0</p>
            </div>
        </div>

        <nav class="flex-1 px-4 py-6 space-y-1">
            <button onclick="switchTab('dashboard')" id="btn-dashboard" class="sidebar-item w-full active">
                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg>
                Overview
            </button>
            <button onclick="switchTab('loggers')" id="btn-loggers" class="sidebar-item w-full">
                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                Diagnostics
            </button>
            <button onclick="switchTab('threads')" id="btn-threads" class="sidebar-item w-full">
                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
                Threads
            </button>
            <button onclick="switchTab('metrics')" id="btn-metrics" class="sidebar-item w-full">
                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                Metrics Explorer
            </button>
        </nav>

        <div class="p-4 border-t border-white/5">
            <button onclick="logout()" class="flex items-center w-full px-4 py-2 text-rose-400 hover:text-rose-300 hover:bg-rose-500/10 rounded-lg transition-all text-sm font-semibold">
                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                Sign Out
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col overflow-hidden">
        <!-- Header -->
        <header class="h-16 bg-[#0a0f1d] border-b border-white/5 flex items-center justify-between px-8 z-10">
            <div class="flex items-center space-x-8">
                <div class="flex flex-col">
                    <span class="text-[10px] text-slate-500 font-bold uppercase tracking-wider">System Status</span>
                    <div class="flex items-center space-x-2">
                        <div id="healthDot" class="w-2 h-2 rounded-full bg-emerald-500"></div>
                        <span id="globalHealth" class="text-xs font-semibold text-white">HEALTHY</span>
                    </div>
                </div>
                <div class="flex flex-col border-l border-white/10 pl-8">
                    <span class="text-[10px] text-slate-500 font-bold uppercase tracking-wider">Throughput</span>
                    <span id="rpsValue" class="text-xs font-mono font-semibold text-blue-400">0.00 RPS</span>
                </div>
            </div>
            
            <div class="flex items-center space-x-4">
                <div class="text-right">
                    <p id="adminUser" class="text-xs font-bold text-white">SRE Admin</p>
                    <p id="yangonClock" class="text-[10px] text-slate-500 mono font-medium">--:--:--</p>
                </div>
                <div class="w-10 h-10 rounded-full bg-slate-800 border border-white/10 flex items-center justify-center text-blue-400 font-bold text-sm">A</div>
            </div>
        </header>

        <!-- Scrollable Body -->
        <div class="flex-1 overflow-y-auto p-8 custom-scrollbar bg-[#0f172a]/50">
            <!-- TAB: Dashboard Overview -->
            <div id="tab-dashboard" class="tab-content active space-y-8">
                <!-- Dynamic Application Metrics Grid -->
                <div id="dynamicMetricsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <!-- Cards will be injected here dynamically -->
                </div>

                <!-- Metrics Grid -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="card p-6 flex flex-col justify-between h-36">
                        <div class="flex justify-between items-start">
                            <span class="text-[11px] text-slate-500 font-bold uppercase">Thread Utilization</span>
                            <div class="p-1.5 bg-emerald-500/10 rounded-lg text-emerald-500"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg></div>
                        </div>
                        <div class="flex items-baseline space-x-2">
                            <span id="activeReqs" class="text-3xl font-bold tracking-tight">0</span>
                            <span class="text-xs text-slate-500">Busy</span>
                        </div>
                        <div class="w-full bg-white/5 h-1 rounded-full overflow-hidden mt-2"><div id="reqBar" class="bg-emerald-500 h-full transition-all duration-700" style="width: 0%"></div></div>
                    </div>

                    <div class="card p-6 flex flex-col justify-between h-36">
                        <div class="flex justify-between items-start">
                            <span class="text-[11px] text-slate-500 font-bold uppercase">JVM Heap Consumption</span>
                            <div class="p-1.5 bg-indigo-500/10 rounded-lg text-indigo-500"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg></div>
                        </div>
                        <div class="flex items-baseline space-x-2">
                            <span id="heapText" class="text-3xl font-bold tracking-tight">0</span>
                            <span class="text-xs text-slate-500">MB</span>
                        </div>
                        <div class="text-[10px] text-slate-600 font-medium">Max Alloc: <span id="maxHeapText" class="text-slate-400">0 MB</span></div>
                    </div>

                    <div class="card p-6 flex flex-col justify-between h-36">
                        <div class="flex justify-between items-start">
                            <span class="text-[11px] text-slate-500 font-bold uppercase">CPU Load</span>
                            <div class="p-1.5 bg-amber-500/10 rounded-lg text-amber-500"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"></path></svg></div>
                        </div>
                        <div class="flex items-baseline space-x-2">
                            <span id="cpuText" class="text-3xl font-bold tracking-tight">0%</span>
                        </div>
                        <div class="w-full bg-white/5 h-1 rounded-full overflow-hidden mt-2"><div id="cpuGauge" class="bg-amber-500 h-full transition-all duration-700" style="width: 0%"></div></div>
                    </div>
                </div>

                <!-- Secondary Row -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 card p-6">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-sm font-bold text-white uppercase tracking-wider">Memory Allocation History</h3>
                            <div class="flex space-x-4">
                                <span class="flex items-center text-[10px] text-slate-400 font-medium"><div class="w-2 h-2 rounded-full bg-blue-500 mr-2"></div> Heap Used</span>
                            </div>
                        </div>
                        <div class="h-64"><canvas id="memStreamChart"></canvas></div>
                    </div>

                    <div class="card p-6 flex flex-col">
                        <h3 class="text-sm font-bold text-white uppercase tracking-wider mb-6">System Health</h3>
                        <div id="healthDetailsGrid" class="space-y-4 flex-1">
                            <!-- Dynamic Health -->
                        </div>
                        <div class="mt-6 pt-6 border-t border-white/5">
                            <div class="flex justify-between text-[11px] font-bold uppercase">
                                <span class="text-slate-500">Node Uptime</span>
                                <span id="uptimeText" class="text-blue-400">0h 0m</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Audit Registry -->
                <div class="card overflow-hidden">
                    <div class="px-6 py-4 border-b border-white/5 bg-white/[0.02] flex items-center justify-between">
                        <h3 class="text-[11px] font-bold text-slate-400 uppercase tracking-widest">Runtime Audit Registry</h3>
                        <span id="lastUpdatedYangon" class="text-[10px] font-medium text-slate-500 mono tracking-tighter">--:--:--</span>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-xs">
                            <thead class="text-slate-500 border-b border-white/5 uppercase font-bold tracking-tighter">
                                <tr>
                                    <th class="px-6 py-4">Descriptor</th>
                                    <th class="px-6 py-4">Metric Value</th>
                                    <th class="px-6 py-4">Constraint</th>
                                    <th class="px-6 py-4 text-right">Sampled</th>
                                </tr>
                            </thead>
                            <tbody id="registryBody" class="divide-y divide-white/5 mono text-slate-300">
                                <!-- Dynamic rows -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- TAB: Loggers -->
            <div id="tab-loggers" class="tab-content card p-6">
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 space-y-4 md:space-y-0">
                    <div>
                        <h3 class="text-lg font-bold text-white">Logger Configuration</h3>
                        <p class="text-xs text-slate-500">Manage runtime log levels across the application context.</p>
                    </div>
                    <div class="relative">
                        <input type="text" id="logFilter" placeholder="Filter loggers..." class="bg-slate-900 border border-white/10 rounded-lg px-4 py-2 text-sm outline-none focus:ring-2 ring-blue-500 w-full md:w-80 text-white placeholder-slate-600">
                        <svg class="w-4 h-4 text-slate-600 absolute right-3 top-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    </div>
                </div>
                <div class="max-h-[600px] overflow-y-auto custom-scrollbar border border-white/5 rounded-lg">
                    <table class="w-full text-left text-xs mono">
                        <thead class="bg-white/[0.02] text-slate-500 sticky top-0">
                            <tr>
                                <th class="px-6 py-3">Logger Name</th>
                                <th class="px-6 py-3 text-right">Effective Level</th>
                            </tr>
                        </thead>
                        <tbody id="logTable" class="divide-y divide-white/5"></tbody>
                    </table>
                </div>
            </div>

            <!-- TAB: Metrics Explorer -->
            <div id="tab-metrics" class="tab-content space-y-6">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center space-y-4 md:space-y-0">
                    <div>
                        <h3 class="text-lg font-bold text-white">Metric Discovery</h3>
                        <p class="text-xs text-slate-500">Search and analyze all Micrometer meters registered in the JVM.</p>
                    </div>
                    <div class="relative w-full md:w-96">
                        <input type="text" id="metricSearch" placeholder="Search metrics (e.g. hikari, jvm, http)..." 
                               class="bg-slate-900 border border-white/10 rounded-xl px-4 py-3 text-sm outline-none focus:ring-2 ring-blue-500 w-full text-white placeholder-slate-600">
                        <svg class="w-5 h-5 text-slate-600 absolute right-3 top-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                    <!-- Metric List -->
                    <div class="lg:col-span-4 card overflow-hidden flex flex-col h-[600px]">
                        <div class="px-4 py-3 bg-white/[0.02] border-b border-white/5 text-[10px] font-bold text-slate-500 uppercase tracking-widest">Available Meters</div>
                        <div id="metricNamesList" class="flex-1 overflow-y-auto custom-scrollbar p-2 space-y-1">
                            <!-- Metric names will appear here -->
                        </div>
                    </div>

                    <!-- Metric Detail -->
                    <div id="metricDetailView" class="lg:col-span-8 card p-8 hidden">
                        <div class="flex justify-between items-start mb-8">
                            <div>
                                <h2 id="selectedMetricName" class="text-2xl font-bold text-white tracking-tight mb-1">---</h2>
                                <p id="selectedMetricDesc" class="text-sm text-slate-400">---</p>
                            </div>
                            <div id="selectedMetricBaseUnit" class="px-3 py-1 bg-blue-500/10 text-blue-400 rounded-lg text-[10px] font-black uppercase tracking-widest">---</div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8" id="metricMeasurements">
                            <!-- Measurements will appear here -->
                        </div>

                        <div class="space-y-4">
                            <h4 class="text-[10px] font-black text-slate-500 uppercase tracking-[0.2em]">Available Tags / Dimensions</h4>
                            <div id="metricTags" class="flex flex-wrap gap-2">
                                <!-- Tags will appear here -->
                            </div>
                        </div>
                    </div>

                    <!-- Empty State -->
                    <div id="metricEmptyState" class="lg:col-span-8 card flex flex-col items-center justify-center text-center p-20">
                        <div class="w-16 h-16 bg-slate-800 rounded-2xl flex items-center justify-center text-slate-600 mb-4">
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg>
                        </div>
                        <h3 class="text-white font-bold mb-2">Select a metric to view details</h3>
                        <p class="text-sm text-slate-500 max-w-xs">Discovery engine found <span id="metricCountDiscovered" class="text-blue-400 font-bold">0</span> unique meters in your application context.</p>
                    </div>
                </div>
            </div>

            <!-- TAB: Threads -->
            <div id="tab-threads" class="tab-content space-y-6">
                <div class="flex justify-between items-center">
                    <h3 class="text-lg font-bold text-white">Thread Diagnostic Dump</h3>
                    <button onclick="fetchThreads()" class="px-4 py-2 bg-blue-600 text-white text-xs font-bold rounded-lg hover:bg-blue-700 transition-all flex items-center">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                        Refresh Snapshot
                    </button>
                </div>
                <div id="threadList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 max-h-[700px] overflow-y-auto pr-2 custom-scrollbar"></div>
            </div>

        </div>
    </main>

    <script>
        // Use sessionStorage for authentication persistence
        const token = sessionStorage.getItem('admin_token');
        if (!token) window.location.href = '/z-monitor/login';

        // Timezone management
        function getYangonTime() {
            return new Date().toLocaleString('en-US', { 
                timeZone: 'Asia/Yangon', 
                hour12: false, 
                hour: '2-digit', minute: '2-digit', second: '2-digit'
            });
        }

        function updateClocks() {
            document.getElementById('yangonClock').textContent = getYangonTime() + ' MM-T';
        }
        setInterval(updateClocks, 1000);

        // Core API Communication with Graceful Auth handling
        async function fetchActuator(endpoint) {
            try {
                const response = await fetch(`/actuator/${endpoint}`, { 
                    headers: { 'Authorization': `Bearer ${token}` } 
                });
                
                if (response.status === 401) {
                    console.warn(`Unauthorized access to ${endpoint}. Verify security config.`);
                    // We don't force redirect immediately on every 401 to prevent loop during partial failures
                    // Only redirect if core dashboard metrics fail repeatedly
                    if (endpoint.includes('metrics') || endpoint === 'health') {
                        // window.location.href = '/z-monitor/login';
                    }
                    return null;
                }
                
                if (!response.ok) return null;
                return await response.json();
            } catch (err) {
                console.error(`Fetch error for ${endpoint}:`, err);
                return null;
            }
        }

        // Charts Initialization
        const memChart = new Chart(document.getElementById('memStreamChart').getContext('2d'), {
            type: 'line',
            data: { 
                labels: Array(30).fill(''), 
                datasets: [{ 
                    data: Array(30).fill(0), 
                    borderColor: '#3b82f6', 
                    backgroundColor: 'rgba(59, 130, 246, 0.05)', 
                    borderWidth: 2, fill: true, tension: 0.4, pointRadius: 0 
                }] 
            },
            options: { 
                maintainAspectRatio: false, 
                plugins: { legend: { display: false } },
                scales: { 
                    x: { display: false }, 
                    y: { grid: { color: 'rgba(255,255,255,0.03)' }, ticks: { font: { size: 9 }, color: '#475569' } } 
                } 
            }
        });

        let lastRpsCount = 0;
        let lastRpsTime = Date.now();

        async function updateTelemetry() {
            const now = getYangonTime();
            document.getElementById('lastUpdatedYangon').textContent = `Refreshed: ${now}`;

            // Business Metrics (Dynamic Discovery)
            fetch('/z-monitor/business-metrics', { headers: { 'Authorization': `Bearer ${token}` } })
                .then(r => r.json())
                .then(data => {
                    const container = document.getElementById('dynamicMetricsGrid');
                    if (data && container) {
                        container.innerHTML = Object.entries(data).map(([key, value]) => {
                            // Format key: camelCase -> Title Case
                            const title = key.replace(/([A-Z])/g, ' $1').replace(/^./, s => s.toUpperCase());
                            
                            // Contextual coloring
                            let color = 'border-blue-500 text-blue-500 shadow-blue-500/5';
                            const lowerKey = key.toLowerCase();
                            if (lowerKey.includes('pending') || lowerKey.includes('waiting')) color = 'border-amber-500 text-amber-500 shadow-amber-500/5';
                            if (lowerKey.includes('complete') || lowerKey.includes('settled') || lowerKey.includes('success')) color = 'border-emerald-500 text-emerald-500 shadow-emerald-500/5';
                            if (lowerKey.includes('fail') || lowerKey.includes('error') || lowerKey.includes('reject')) color = 'border-rose-500 text-rose-500 shadow-rose-500/5';

                            return `
                                <div class="card p-5 border-l-4 ${color} transition-all hover:translate-y-[-2px]">
                                    <p class="text-[10px] text-slate-500 font-black uppercase tracking-wider mb-2">${title}</p>
                                    <p class="text-3xl font-mono font-bold">${typeof value === 'number' ? value.toLocaleString() : value}</p>
                                </div>
                            `;
                        }).join('');
                    }
                }).catch(() => {});

            // System Load & Throughput
            const busyThreads = await fetchActuator('metrics/tomcat.threads.busy');
            if (busyThreads) {
                const val = busyThreads.measurements[0].value;
                document.getElementById('activeReqs').textContent = val;
                document.getElementById('reqBar').style.width = `${Math.min((val/20)*100, 100)}%`;
            }

            const rpsData = await fetchActuator('metrics/http.server.requests');
            if (rpsData) {
                const count = rpsData.measurements.find(m => m.statistic === 'COUNT')?.value || 0;
                const nowMs = Date.now();
                const rps = (count - lastRpsCount) / ((nowMs - lastRpsTime) / 1000);
                document.getElementById('rpsValue').textContent = `${Math.max(0, rps).toFixed(2)} RPS`;
                lastRpsCount = count;
                lastRpsTime = nowMs;
            }

            // JVM & Resources
            const memory = await fetchActuator('metrics/jvm.memory.used');
            const maxMem = await fetchActuator('metrics/jvm.memory.max');
            if (memory) {
                const usedMB = Math.round(memory.measurements[0].value / 1024 / 1024);
                document.getElementById('heapText').textContent = usedMB;
                if (maxMem) {
                    const maxMB = Math.round(maxMem.measurements[0].value / 1024 / 1024);
                    document.getElementById('maxHeapText').textContent = `${maxMB} MB`;
                }
                memChart.data.datasets[0].data.push(usedMB);
                memChart.data.datasets[0].data.shift();
                memChart.update('none');
            }

            const uptime = await fetchActuator('metrics/process.uptime');
            if (uptime) {
                const seconds = uptime.measurements[0].value;
                const h = Math.floor(seconds / 3600);
                const m = Math.floor((seconds % 3600) / 60);
                document.getElementById('uptimeText').textContent = `${h}h ${m}m`;
            }

            const cpu = await fetchActuator('metrics/system.cpu.usage');
            if (cpu) {
                const val = (cpu.measurements[0].value * 100).toFixed(1);
                document.getElementById('cpuText').textContent = `${val}%`;
                document.getElementById('cpuGauge').style.width = `${val}%`;
            }

            // Health
            const health = await fetchActuator('health');
            const healthContainer = document.getElementById('healthDetailsGrid');
            if (health) {
                const isUp = health.status === 'UP';
                document.getElementById('globalHealth').textContent = isUp ? 'OPTIMIZED' : 'DEGRADED';
                document.getElementById('globalHealth').className = `text-xs font-semibold ${isUp ? 'text-emerald-500' : 'text-rose-500'}`;
                document.getElementById('healthDot').className = `w-2 h-2 rounded-full ${isUp ? 'bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.5)]' : 'bg-rose-500'}`;
                
                // Handle both components and details (Spring Boot health structure variants)
                const components = health.components || health.details || {};
                healthContainer.innerHTML = Object.entries(components).length > 0 
                    ? Object.entries(components).map(([name, data]) => `
                        <div class="flex justify-between items-center text-[11px] font-medium">
                            <span class="text-slate-500 uppercase tracking-tight">${name}</span>
                            <span class="status-pill ${data.status === 'UP' ? 'status-up' : 'status-down'}">${data.status || 'N/A'}</span>
                        </div>
                    `).join('')
                    : '<div class="text-[10px] text-slate-600 italic">No sub-components reported</div>';
            } else {
                document.getElementById('globalHealth').textContent = 'OFFLINE';
                document.getElementById('healthDot').className = 'w-2 h-2 rounded-full bg-slate-700';
                healthContainer.innerHTML = '<div class="text-[10px] text-rose-500 italic">Failed to fetch health data</div>';
            }

            // Audit Registry
            const auditMetrics = ['jvm.threads.live', 'process.uptime', 'jvm.gc.pause'];
            let auditHtml = '';
            for (const mName of auditMetrics) {
                const m = await fetchActuator(`metrics/${mName}`);
                if (m) {
                    const val = m.measurements[0].value.toFixed(0);
                    auditHtml += `<tr><td class="px-6 py-4 text-slate-500">${mName}</td><td class="px-6 py-4 font-bold text-white">${val}</td><td class="px-6 py-4 text-blue-500">STABLE</td><td class="px-6 py-4 text-right text-slate-600">${now}</td></tr>`;
                }
            }
            document.getElementById('registryBody').innerHTML = auditHtml;
        }

        // Tab Switching
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.sidebar-item').forEach(el => el.classList.remove('active'));
            
            document.getElementById('tab-' + tabId).classList.add('active');
            document.getElementById('btn-' + tabId).classList.add('active');
            
            if (tabId === 'loggers') fetchLoggers();
            if (tabId === 'threads') fetchThreads();
            if (tabId === 'metrics') fetchDiscoverableMetrics();
        }

        // Metrics Explorer Logic
        let allMetricNames = [];
        async function fetchDiscoverableMetrics() {
            const data = await fetchActuator('metrics');
            if (data && data.names) {
                allMetricNames = data.names.sort();
                document.getElementById('metricCountDiscovered').textContent = allMetricNames.length;
                renderMetricList(allMetricNames);
                
                document.getElementById('metricSearch').oninput = (e) => {
                    const query = e.target.value.toLowerCase();
                    const filtered = allMetricNames.filter(n => n.toLowerCase().includes(query));
                    renderMetricList(filtered);
                };
            }
        }

        function renderMetricList(names) {
            const container = document.getElementById('metricNamesList');
            container.innerHTML = names.map(name => `
                <button onclick="viewMetricDetail('${name}')" 
                        class="w-full text-left px-4 py-2.5 rounded-lg text-xs font-medium transition-all hover:bg-blue-500/10 hover:text-blue-400 border border-transparent hover:border-blue-500/20 text-slate-400 truncate">
                    ${name}
                </button>
            `).join('');
        }

        async function viewMetricDetail(name) {
            const data = await fetchActuator(`metrics/${name}`);
            if (!data) return;

            // UI Transitions
            document.getElementById('metricEmptyState').classList.add('hidden');
            const detailView = document.getElementById('metricDetailView');
            detailView.classList.remove('hidden');
            detailView.scrollIntoView({ behavior: 'smooth', block: 'start' });

            // Basic Info
            document.getElementById('selectedMetricName').textContent = name;
            document.getElementById('selectedMetricDesc').textContent = data.description || 'No description available for this meter.';
            document.getElementById('selectedMetricBaseUnit').textContent = data.baseUnit || 'Unitless';

            // Measurements
            document.getElementById('metricMeasurements').innerHTML = data.measurements.map(m => `
                <div class="bg-slate-900/50 border border-white/5 p-4 rounded-xl">
                    <p class="text-[9px] font-black text-slate-500 uppercase tracking-widest mb-1">${m.statistic}</p>
                    <p class="text-xl font-bold text-white mono">${m.value.toLocaleString(undefined, { maximumFractionDigits: 4 })}</p>
                </div>
            `).join('');

            // Tags
            const tagsContainer = document.getElementById('metricTags');
            if (data.availableTags && data.availableTags.length > 0) {
                tagsContainer.innerHTML = data.availableTags.map(tag => `
                    <div class="flex flex-col bg-white/[0.03] border border-white/5 p-3 rounded-lg min-w-[120px]">
                        <span class="text-[9px] font-black text-blue-500 uppercase mb-2">${tag.tag}</span>
                        <div class="flex flex-wrap gap-1">
                            ${tag.values.slice(0, 5).map(v => `<span class="px-1.5 py-0.5 bg-slate-800 text-[10px] text-slate-400 rounded">${v}</span>`).join('')}
                            ${tag.values.length > 5 ? `<span class="text-[10px] text-slate-600 pl-1">+${tag.values.length - 5} more</span>` : ''}
                        </div>
                    </div>
                `).join('');
            } else {
                tagsContainer.innerHTML = '<p class="text-xs text-slate-600 italic">No dimensions available for this metric.</p>';
            }
        }

        async function fetchLoggers() {
            const data = await fetchActuator('loggers');
            if (data) {
                renderLoggers(data.loggers);
                document.getElementById('logFilter').oninput = (e) => {
                    const filtered = Object.fromEntries(Object.entries(data.loggers).filter(([k]) => k.toLowerCase().includes(e.target.value.toLowerCase())));
                    renderLoggers(filtered);
                };
            } else {
                document.getElementById('logTable').innerHTML = '<tr><td colspan="2" class="p-6 text-center text-rose-500">Loggers endpoint inaccessible (401/404)</td></tr>';
            }
        }

        function renderLoggers(loggers) {
            document.getElementById('logTable').innerHTML = Object.entries(loggers).map(([name, config]) => `
                <tr class="hover:bg-white/[0.01]">
                    <td class="px-6 py-3 text-slate-400 max-w-md truncate">${name}</td>
                    <td class="px-6 py-3 text-right"><span class="px-2 py-0.5 rounded bg-blue-500/10 text-blue-500 font-bold">${config.effectiveLevel}</span></td>
                </tr>
            `).join('');
        }

        async function fetchThreads() {
            const data = await fetchActuator('threaddump');
            if (data) {
                document.getElementById('threadList').innerHTML = data.threads.map(t => `
                    <div class="card p-4 text-[10px] hover:border-blue-500/50 cursor-default">
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-bold text-blue-400 truncate pr-2">#${t.threadId} ${t.threadName}</span>
                            <span class="px-1.5 py-0.5 rounded-full ${t.threadState === 'RUNNABLE' ? 'bg-emerald-500/10 text-emerald-500' : 'bg-slate-500/10 text-slate-500'} font-bold uppercase">${t.threadState}</span>
                        </div>
                        <div class="text-slate-500 mono opacity-60 truncate">${t.stackTrace[0]?.className || 'native'}.${t.stackTrace[0]?.methodName || ''}</div>
                    </div>
                `).join('');
            }
        }

        function logout() { sessionStorage.clear(); window.location.href = '/z-monitor/login'; }

        // Start Node
        updateTelemetry();
        const refreshInterval = [[${refreshInterval}]];
        setInterval(updateTelemetry, refreshInterval);
    </script>
</body>
</html>
